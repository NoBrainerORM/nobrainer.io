<!doctype html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>Real Time Tutorial Â· NoBrainer</title>
  <link rel="stylesheet" href="/css/screen.css" />
</head>

<body class="wrap">
  <header>
  <div class="grid">
    <div class="unit one-fifth"> </div>
    <div class="unit four-fifths">
      <h1> <a href="/"> <span>NoBrainer</span> </a> </h1>
      <h3>A Ruby ORM for RethinkDB</h3>
    </div>
  </div>

<!-- put back when we do it properly for mobiles -->
<!-- <a href="https://github.com/nviennot/nobrainer"><img style="position: absolute; top: 0; right:0; border: 0; width: 149px; height: 149px;" src="/img/forkme.png" alt="Fork me on GitHub"></a> -->

</header>


  <section class="docs">
  <div class="grid">

    <div class="unit one-fifth">
  <aside>
    <h4>Getting Started</h4> 

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/introduction/">Introduction</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/installation/">Installation</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/differences_from_other_orms/">Differences from other ORMs</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Models</h4>          

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/models/">Models</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/fields/">Fields</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/types/">Types</a></li>
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/timestamps/">Timestamps</a></li>
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/serialization/">Serialization</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/persistence/">Persistence</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/callbacks/">Callbacks</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/validations/">Validations</a></li>
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/dirty_tracking/">Dirty Tracking</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
      <li class=""><a href="/docs/associations/">Associations</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/store_accessor/">Store accessor</a></li>
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Querying</h4>        

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/querying/">Querying</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/scopes/">Scopes</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/joins/">Joins</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/eager_loading/">Eager Loading</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Advanced Topics</h4> 

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/rql_layer/">RQL Layer</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/indexes/">Indexes</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
      <li class=""><a href="/docs/atomic_ops/">Atomic Operations</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/distributed_locks/">Distributed Locks</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/db_management/">DB Management</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/table_configuration/">Table Configuration</a></li>
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/multi_tenancy/">Multi Tenancy</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/caching/">Caching</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/event_machine/">Event Machine</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Recipes</h4>         

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class="current"><a href="/docs/real_time_tutorial/">Real Time Tutorial</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Miscellaneous</h4>   

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/roadmap/">Roadmap</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/changelog/">Changelog</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
      <li class=""><a href="/docs/3rd_party_integration/">3rd-party Integration</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/testing/">Testing</a></li>
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/communication/">Communication</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/faq/">FAQ</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/credits/">Credits</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

  </aside>
</div>


    <div class="like-buttons">
      <div class="github">
        <iframe src="/github-btn.html?user=nviennot&repo=nobrainer&type=watch&count=true"
          allowtransparency="true" frameborder="0" scrolling="0" width="100" height="20"></iframe>
      </div>
    </div>

    <div class="unit four-fifths">
      <article>
        <h1>Real Time Tutorial</h1>
        <p>The following showcases an example of using RethinkDB, NoBrainer,
<a href="https://github.com/eventmachine/eventmachine">EventMachine</a>,
<a href="https://github.com/postrank-labs/goliath">Goliath</a> and
<a href="http://ruby-doc.org/core-2.2.0/Fiber.html">Ruby fibers</a> to
demonstrate RethinkDB real-time features through a simple HTTP interface.</p>

<p>Our application contains 3 files: <code class="language-plaintext highlighter-rouge">Gemfile</code>, <code class="language-plaintext highlighter-rouge">init.rb</code> and <code class="language-plaintext highlighter-rouge">app.rb</code>,
which respectively specify the gems weâll be using, the application
configuration, and the application logic.</p>

<h2 id="gemfile">Gemfile</h2>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">gem</span> <span class="s1">'goliath'</span><span class="p">,</span> <span class="s1">'~&gt; 1.0.4'</span>
<span class="n">gem</span> <span class="s1">'nobrainer'</span><span class="p">,</span> <span class="s1">'~&gt; 0.29.0'</span></code></pre></figure>

<h2 id="initrb">init.rb</h2>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># First we load our gems.</span>
<span class="nb">require</span> <span class="s1">'bundler'</span>
<span class="no">Bundler</span><span class="p">.</span><span class="nf">require</span>

<span class="c1"># Then we configure NoBrainer.</span>
<span class="no">NoBrainer</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">app_name</span> <span class="o">=</span> <span class="s2">"goliath"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">environment</span> <span class="o">=</span> <span class="no">Goliath</span><span class="p">.</span><span class="nf">env</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">driver</span> <span class="o">=</span> <span class="ss">:em</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">STDERR</span><span class="p">).</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">log</span><span class="o">|</span> <span class="n">log</span><span class="p">.</span><span class="nf">level</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">::</span><span class="no">DEBUG</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># Next, we define a helper method `stream(&amp;block)' that immediately returns</span>
<span class="c1"># HTTP headers to the client, and schedule the passed blocked to be ran in a</span>
<span class="c1"># Fiber at the next EventMachine tick. Because we must not let any exceptions</span>
<span class="c1"># bubble up from the fiber to prevent killing the EventMachine loop, we catch</span>
<span class="c1"># them and handle them accordingly in `guard_async_response()'.</span>

<span class="k">module</span> <span class="nn">StreamFiber</span>
  <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="no">EM</span><span class="p">.</span><span class="nf">next_tick</span> <span class="p">{</span> <span class="no">Fiber</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="n">guard_async_response</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">}.</span><span class="nf">resume</span> <span class="p">}</span>
    <span class="n">chunked_streaming_response</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">guard_async_response</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="k">begin</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:error</span> <span class="o">=&gt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">).</span><span class="nf">first</span><span class="si">}</span><span class="s2">"</span><span class="p">}</span>
      <span class="no">STDERR</span><span class="p">.</span><span class="nf">puts</span> <span class="n">msg</span>
      <span class="n">env</span><span class="p">.</span><span class="nf">chunked_stream_send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">msg</span><span class="p">.</span><span class="nf">to_json</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">rescue</span>
    <span class="k">end</span>
  <span class="k">ensure</span>
    <span class="n">env</span><span class="p">.</span><span class="nf">chunked_stream_close</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Then, we introduce a helper to cancel outstanding requests made to the</span>
<span class="c1"># database when an HTTP client disconnect.</span>
<span class="c1"># `bind_cursor_to_connection(env, cursor)' binds a NoBrainer cursor to an</span>
<span class="c1"># HTTP connection, meaning that when the connection gets closed through the</span>
<span class="c1"># `on_close()' Goliath callback, `close()' is called on all registered</span>
<span class="c1"># cursors.</span>

<span class="k">module</span> <span class="nn">BindCursor</span>
  <span class="k">def</span> <span class="nf">bind_cursor_to_connection</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">'connection_closed'</span><span class="p">]</span>
      <span class="n">cursor</span><span class="p">.</span><span class="nf">close</span>
    <span class="k">else</span>
      <span class="n">env</span><span class="p">[</span><span class="s1">'cursors'</span><span class="p">]</span> <span class="o">||=</span> <span class="p">[]</span>
      <span class="n">env</span><span class="p">[</span><span class="s1">'cursors'</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">cursor</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">env</span><span class="p">[</span><span class="s1">'connection_closed'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="n">env</span><span class="p">[</span><span class="s1">'cursors'</span><span class="p">].</span><span class="nf">to_a</span><span class="p">.</span><span class="nf">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:close</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h2 id="apprb">app.rb</h2>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'./init'</span>

<span class="c1"># We define a simple Item model with two fields: an SKU with a uniqueness</span>
<span class="c1"># constraint, and a name.</span>

<span class="k">class</span> <span class="nc">Item</span>
  <span class="kp">include</span> <span class="no">NoBrainer</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:sku</span><span class="p">,</span>  <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">String</span><span class="p">,</span> <span class="ss">:required</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:uniq</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">String</span>
<span class="k">end</span>

<span class="c1"># We define our Goliath application which responds to the /upsert and /changes</span>
<span class="c1"># endpoints. /upsert simply upserts Items (insert if not found, update if</span>
<span class="c1"># found), and /changes opens a firehose emitting changes on the items table.</span>

<span class="k">class</span> <span class="nc">App</span> <span class="o">&lt;</span> <span class="no">Goliath</span><span class="o">::</span><span class="no">API</span>
  <span class="n">use</span> <span class="no">Goliath</span><span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Params</span>
  <span class="kp">include</span> <span class="no">StreamFiber</span>
  <span class="kp">include</span> <span class="no">BindCursor</span>

  <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">item</span> <span class="o">=</span> <span class="no">Item</span><span class="p">.</span><span class="nf">upsert!</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">'params'</span><span class="p">])</span>
    <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="n">item</span><span class="p">.</span><span class="nf">to_json</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">changes</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">stream</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">Item</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">'params'</span><span class="p">]).</span><span class="nf">raw</span><span class="p">.</span><span class="nf">changes</span><span class="p">(</span><span class="ss">:include_states</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">cursor</span><span class="o">|</span> <span class="n">bind_cursor_to_connection</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">changes</span><span class="o">|</span> <span class="n">env</span><span class="p">.</span><span class="nf">chunked_stream_send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">changes</span><span class="p">.</span><span class="nf">to_json</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">case</span> <span class="p">[</span><span class="n">env</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">].</span><span class="nf">downcase</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s1">'PATH_INFO'</span><span class="p">]]</span>
      <span class="k">when</span> <span class="p">[</span><span class="ss">:post</span><span class="p">,</span> <span class="s1">'/upsert'</span><span class="p">]</span>  <span class="k">then</span> <span class="n">upsert</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="k">when</span> <span class="p">[</span><span class="ss">:get</span><span class="p">,</span>  <span class="s1">'/changes'</span><span class="p">]</span> <span class="k">then</span> <span class="n">changes</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">raise</span> <span class="no">Goliath</span><span class="o">::</span><span class="no">Validation</span><span class="o">::</span><span class="no">NotFoundError</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h2 id="running-the-example">Running the Example</h2>

<p>When running the server as shown below, we can issue requests on our server.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ruby app.rb <span class="nt">-sv</span>
<span class="o">[</span>28846:INFO] 2015-08-17 02:13:51 :: Starting server on 0.0.0.0:9000 <span class="k">in </span>development mode. Watch out <span class="k">for </span>stones.</code></pre></figure>

<h3 id="example-1-creating-a-valid-item">Example 1: Creating a valid Item</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST localhost:9000/upsert?sku<span class="o">=</span>123<span class="se">\&amp;</span><span class="nv">name</span><span class="o">=</span>hello
<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"2J3EyCBX5JyjIX"</span>,<span class="s2">"name"</span>:<span class="s2">"hello"</span>,<span class="s2">"sku"</span>:<span class="s2">"123"</span><span class="o">}</span></code></pre></figure>

<h3 id="example-2-creating-an-invalid-item">Example 2: Creating an invalid Item</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST localhost:9000/upsert
<span class="o">[</span>:error, <span class="s2">"#&lt;Item id: </span><span class="se">\"</span><span class="s2">blah</span><span class="se">\"</span><span class="s2">&gt; is invalid: Sku can't be blank"</span><span class="o">]</span></code></pre></figure>

<h3 id="example-3-modifying-items-while-listening-for-changes">Example 3: Modifying items while listening for changes</h3>

<p>First we listen for changes:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl localhost:9000/changes
<span class="o">{</span><span class="s2">"state"</span>:<span class="s2">"ready"</span><span class="o">}</span></code></pre></figure>

<p>Then we open a new shell and run:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST localhost:9000/upsert?sku<span class="o">=</span>456<span class="se">\&amp;</span><span class="nv">name</span><span class="o">=</span>hello
<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"2J3K0C71Nn0RQ6"</span>,<span class="s2">"name"</span>:<span class="s2">"hello"</span>,<span class="s2">"sku"</span>:<span class="s2">"456"</span><span class="o">}</span>
<span class="nv">$ </span>curl <span class="nt">-X</span> POST localhost:9000/upsert?sku<span class="o">=</span>456<span class="se">\&amp;</span><span class="nv">name</span><span class="o">=</span>ohai
<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"2J3K0C71Nn0RQ6"</span>,<span class="s2">"name"</span>:<span class="s2">"ohai"</span>,<span class="s2">"sku"</span>:<span class="s2">"456"</span><span class="o">}</span>
<span class="nv">$ </span>curl <span class="nt">-X</span> POST localhost:9000/upsert?sku<span class="o">=</span>456
<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"2J3K0C71Nn0RQ6"</span>,<span class="s2">"name"</span>:<span class="s2">"ohai"</span>,<span class="s2">"sku"</span>:<span class="s2">"456"</span><span class="o">}</span></code></pre></figure>

<p>We see on previous curl appear:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl localhost:9000/changes
<span class="o">{</span><span class="s2">"state"</span>:<span class="s2">"ready"</span><span class="o">}</span>
<span class="o">{</span><span class="s2">"new_val"</span>:<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"2J3K0C71Nn0RQ6"</span>,<span class="s2">"name"</span>:<span class="s2">"hello"</span>,<span class="s2">"sku"</span>:<span class="s2">"456"</span><span class="o">}</span>,<span class="s2">"old_val"</span>:null<span class="o">}</span>
<span class="o">{</span><span class="s2">"new_val"</span>:<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"2J3K0C71Nn0RQ6"</span>,<span class="s2">"name"</span>:<span class="s2">"ohai"</span>,<span class="s2">"sku"</span>:<span class="s2">"456"</span><span class="o">}</span>,<span class="s2">"old_val"</span>:<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"2J3K0C71Nn0RQ6"</span>,<span class="s2">"name"</span>:<span class="s2">"hello"</span>,<span class="s2">"sku"</span>:<span class="s2">"456"</span><span class="o">}}</span></code></pre></figure>

<h3 id="example-4-listening-for-changes-on-a-specific-subject">Example 4: Listening for changes on a specific subject</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl localhost:9000/changes?sku<span class="o">=</span>222</code></pre></figure>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST localhost:9000/upsert?sku<span class="o">=</span>111
<span class="nv">$ </span>curl <span class="nt">-X</span> POST localhost:9000/upsert?sku<span class="o">=</span>222</code></pre></figure>

<p>We only see the changes of the second Item, not the first one.</p>

<h3 id="example-5-running-many-clients">Example 5: Running many clients</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="sb">`</span><span class="nb">seq </span>10<span class="sb">`</span><span class="p">;</span> <span class="k">do </span>curl <span class="nt">-N</span> localhost:9000/changes &amp;<span class="p">;</span> <span class="k">done</span></code></pre></figure>

<p>We see 10 times <code class="language-plaintext highlighter-rouge">{"state":"ready"}</code></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST localhost:9000/upsert?sku<span class="o">=</span>333</code></pre></figure>

<p>We see 10 times <code class="language-plaintext highlighter-rouge">{"new_val":{"id":"2J3MDIpNLPchjS","sku":"333"},"old_val":null}</code>.</p>

<p>This demonstrate that our server can handle many clients simultaneously.</p>

<h3 id="example-6-handling-connection-failures">Example 6: Handling connection failures</h3>

<p>If we kill the RethinkDB server while a <code class="language-plaintext highlighter-rouge">/changes</code> call is in progress, we see
the following:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl localhost:9000/changes
<span class="o">{</span><span class="s2">"state"</span>:<span class="s2">"ready"</span><span class="o">}</span>
&lt;<span class="nt">--</span> <span class="nb">kill </span>the RethinkDB server at this point <span class="nt">--</span><span class="o">&gt;</span>
<span class="o">{</span><span class="s2">"error"</span>:<span class="s2">"RethinkDB::RqlDriverError: Connection closed by server."</span><span class="o">}</span>
<span class="nv">$ </span></code></pre></figure>

<p>If we re-issue the curl command, our web server rejects immediately our request.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl localhost:9000/changes
<span class="o">{</span><span class="s2">"error"</span>:<span class="s2">"RethinkDB::RqlRuntimeError: Connection is closed."</span><span class="o">}</span>
<span class="err">$</span></code></pre></figure>

<p>Once we restart the RethinkDB server, we can reissue requests immediately:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl localhost:9000/changes
<span class="o">{</span><span class="s2">"state"</span>:<span class="s2">"ready"</span><span class="o">}</span></code></pre></figure>


      </article>
    </div>

    <div class="clear"></div>

  </div>
</section>


  <footer>
  <div class="grid">
    <div class="unit whole">
      NoBrainer was created by <a href="https://github.com/nviennot">Nicolas Viennot</a>
      and is maintained by <a href="https://github.com/zedtux">Guillaume Hain</a>.
    </div>
  </div>
</footer>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46753546-1', 'nobrainer.io');
  ga('send', 'pageview');
</script>

</body>
</html>
