<!doctype html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>Persistence Â· NoBrainer</title>
  <link rel="stylesheet" href="/css/screen.css" />
</head>

<body class="wrap">
  <header>
  <div class="grid">
    <div class="unit one-fifth"> </div>
    <div class="unit four-fifths">
      <h1> <a href="/"> <span>NoBrainer</span> </a> </h1>
      <h3>A Ruby ORM for RethinkDB</h3>
    </div>
  </div>

<!-- put back when we do it properly for mobiles -->
<!-- <a href="https://github.com/nviennot/nobrainer"><img style="position: absolute; top: 0; right:0; border: 0; width: 149px; height: 149px;" src="/img/forkme.png" alt="Fork me on GitHub"></a> -->

</header>


  <section class="docs">
  <div class="grid">

    <div class="unit one-fifth">
  <aside>
    <h4>Getting Started</h4> 

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/introduction/">Introduction</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/installation/">Installation</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/differences_from_other_orms/">Differences from other ORMs</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Models</h4>          

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/models/">Models</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/fields/">Fields</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/types/">Types</a></li>
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/timestamps/">Timestamps</a></li>
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/serialization/">Serialization</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class="current"><a href="/docs/persistence/">Persistence</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/callbacks/">Callbacks</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/validations/">Validations</a></li>
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/dirty_tracking/">Dirty Tracking</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
      <li class=""><a href="/docs/associations/">Associations</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/store_accessor/">Store accessor</a></li>
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Querying</h4>        

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/querying/">Querying</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/scopes/">Scopes</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/joins/">Joins</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/eager_loading/">Eager Loading</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Advanced Topics</h4> 

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/rql_layer/">RQL Layer</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/indexes/">Indexes</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
      <li class=""><a href="/docs/atomic_ops/">Atomic Operations</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/distributed_locks/">Distributed Locks</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/db_management/">DB Management</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/table_configuration/">Table Configuration</a></li>
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/multi_tenancy/">Multi Tenancy</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/caching/">Caching</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/event_machine/">Event Machine</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Recipes</h4>         

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/real_time_tutorial/">Real Time Tutorial</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

    <h4>Miscellaneous</h4>   

<ul>

  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/roadmap/">Roadmap</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/changelog/">Changelog</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
      <li class=""><a href="/docs/3rd_party_integration/">3rd-party Integration</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/testing/">Testing</a></li>
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/communication/">Communication</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/faq/">FAQ</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  


  

  

  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <li class=""><a href="/docs/credits/">Credits</a></li>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
</ul>

  </aside>
</div>


    <div class="like-buttons">
      <div class="github">
        <iframe src="/github-btn.html?user=nviennot&repo=nobrainer&type=watch&count=true"
          allowtransparency="true" frameborder="0" scrolling="0" width="100" height="20"></iframe>
      </div>
    </div>

    <div class="unit four-fifths">
      <article>
        <h1>Persistence</h1>
        <h2 id="persistence-api">Persistence API</h2>

<p>NoBrainer provides a similar persistence interface compared to other ORMs.</p>

<p>The following methods are available on the <code class="language-plaintext highlighter-rouge">Model</code> class:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Model.new(attrs)</code> instantiate a new Model instance. Default values are set
and <code class="language-plaintext highlighter-rouge">attrs</code> is passed to <code class="language-plaintext highlighter-rouge">assign_attributes</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Model.create(attrs)</code> calls <code class="language-plaintext highlighter-rouge">Model.new(attrs)</code> and then <code class="language-plaintext highlighter-rouge">save</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Model.create!(attrs)</code> calls <code class="language-plaintext highlighter-rouge">Model.new(attrs)</code> and then <code class="language-plaintext highlighter-rouge">save!</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">upsert</code>, <code class="language-plaintext highlighter-rouge">upsert!</code>, <code class="language-plaintext highlighter-rouge">first_or_create</code> and <code class="language-plaintext highlighter-rouge">first_or_create!</code>: see below.</li>
  <li><code class="language-plaintext highlighter-rouge">Model.insert_all([doc1, doc2, ..., docN])</code> is used for bulk inserts. This method
receives a list of hashes, and will not instantiate any models. Instead it
passes the documents in bulk to the database to perform efficient writes.
If the documents primary keys are left unspecified, the database will assign
default UUIDs and <code class="language-plaintext highlighter-rouge">insert_all</code> will return the list of generated ids.
You may use <code class="language-plaintext highlighter-rouge">NoBrainer::Document::PrimaryKey::Generator.generate</code> to generate
MongoDB style ids to match the format of model instances.</li>
  <li><code class="language-plaintext highlighter-rouge">Model.sync</code> is a wrapper for <a href="http://www.rethinkdb.com/api/ruby/#sync"><code class="language-plaintext highlighter-rouge">r.sync()</code></a>.</li>
</ul>

<p>The following predicates are available on a model instance:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">new_record?</code> returns true if the instance has not yet been persisted.</li>
  <li><code class="language-plaintext highlighter-rouge">destroyed?</code> returns true if the instance has been destroyed.</li>
  <li><code class="language-plaintext highlighter-rouge">persisted?</code> returns true if the instance has been persisted and not destroyed.</li>
</ul>

<p>The following methods are available on a model instance:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">save</code> returns true if the instance was valid and saved, otherwise false.</li>
  <li><code class="language-plaintext highlighter-rouge">save?</code> is an alias for <code class="language-plaintext highlighter-rouge">save</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">save!</code> calls <code class="language-plaintext highlighter-rouge">save</code> and raises <code class="language-plaintext highlighter-rouge">NoBrainer::Error::DocumentInvalid</code> if <code class="language-plaintext highlighter-rouge">save</code> returned false.</li>
  <li><code class="language-plaintext highlighter-rouge">update()</code> calls <code class="language-plaintext highlighter-rouge">assign_attributes()</code> and <code class="language-plaintext highlighter-rouge">save</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">update?()</code> is an alias for <code class="language-plaintext highlighter-rouge">update()</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">update!</code> calls <code class="language-plaintext highlighter-rouge">update</code> and raises <code class="language-plaintext highlighter-rouge">NoBrainer::Error::DocumentInvalid</code> if <code class="language-plaintext highlighter-rouge">update</code> returned false.</li>
  <li><code class="language-plaintext highlighter-rouge">delete</code> removes the document from the database without firing the destroy
callbacks.</li>
  <li><code class="language-plaintext highlighter-rouge">destroy</code> fires the destroy callbacks and removes the document from the database.</li>
  <li><code class="language-plaintext highlighter-rouge">reload</code> removes all instance variables that the instance may have, to nuke any
sort of cache. <code class="language-plaintext highlighter-rouge">reload</code> then loads a fresh record from the database and
calls the <code class="language-plaintext highlighter-rouge">initialize()</code> method, which triggers the <code class="language-plaintext highlighter-rouge">initialize</code> callbacks.
You may pass an option <code class="language-plaintext highlighter-rouge">:keep_ivars =&gt; true</code> to prevent <code class="language-plaintext highlighter-rouge">reload</code> from cleaning
up the instance variables.<br />
A <code class="language-plaintext highlighter-rouge">NoBrainer::Error::DocumentNotFound</code> error will be raised if the document
can no longer be found.</li>
</ul>

<p>Note that <code class="language-plaintext highlighter-rouge">delete</code>, <code class="language-plaintext highlighter-rouge">destroy</code>, or <code class="language-plaintext highlighter-rouge">save</code> during updates do not raise if the
instance document no longer exists in the database when performing the
operation.  These methods will silently fail.</p>

<p>NoBrainer never autosaves a model behind the scene. When working with a
database that does not support transactions such as RethinkDB, you need to be in
full control of when database writes occur. There is therefore no autosave
features in NoBrainer and all the writes need to be explicit.</p>

<p>Database writes can also be performed on criteria with <code class="language-plaintext highlighter-rouge">update_all()</code>,
<code class="language-plaintext highlighter-rouge">replace_all()</code>, <code class="language-plaintext highlighter-rouge">delete_all</code> and <code class="language-plaintext highlighter-rouge">destroy_all</code>.
Learn more in the <a href="/docs/querying">Querying</a> section.</p>

<h2 id="upsert">upsert</h2>

<p>NoBrainer provides an API to fetch and update a record, or create it if not
found. This is done atomically. Validations are The usage is shown as below:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">instance</span> <span class="o">=</span> <span class="no">Model</span><span class="p">.</span><span class="nf">upsert</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
<span class="k">unless</span> <span class="n">instance</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">present?</span>
  <span class="c1"># validations failed when creating or updating the instance</span>
<span class="k">end</span>

<span class="n">instance</span> <span class="o">=</span> <span class="no">Model</span><span class="p">.</span><span class="nf">upsert!</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="c1"># raises when validations fail.</span></code></pre></figure>

<p>Note that NoBrainer will need to match either the primary key in attrs, or a
field that has a uniqueness validator as the <code class="language-plaintext highlighter-rouge">upsert</code> uses
the <code class="language-plaintext highlighter-rouge">first_or_create</code> mechanism  as described below.</p>

<h2 id="first_or_create">first_or_create</h2>

<p>NoBrainer provides an API to fetch a record, or create a record if not found.
This is done atomically. The usage is shown below:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># passing params inline</span>
<span class="n">doc</span> <span class="o">=</span> <span class="no">Model</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">some_condition</span><span class="p">).</span><span class="nf">first_or_create!</span><span class="p">(</span><span class="n">additional_params</span><span class="p">)</span>

<span class="c1"># passing params within a block</span>
<span class="n">doc</span> <span class="o">=</span> <span class="no">Model</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">some_condition</span><span class="p">).</span><span class="nf">first_or_create!</span> <span class="k">do</span>
  <span class="c1"># Only called if where().first was not found.</span>
  <span class="n">additional_params</span>
<span class="k">end</span></code></pre></figure>

<p>NoBrainer performs the following stpes:</p>

<ol>
  <li>A lock around <code class="language-plaintext highlighter-rouge">some_condition</code> is acquired.</li>
  <li>If <code class="language-plaintext highlighter-rouge">where(some_condition).first</code> matches a document, the lock is released and
the document is returned.</li>
  <li>Otherwise, <code class="language-plaintext highlighter-rouge">Model.create(some_condition.merge(additional_params))</code> is
performed, and the lock is released right after the persistance operation.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">some_condition</code> must match a defined uniqueness validator to enforce the
atomicity properly. NoBrainer will provide helpful error message if it cannot
find any. This ensure that <code class="language-plaintext highlighter-rouge">first_or_create()</code> does not race with any other
<code class="language-plaintext highlighter-rouge">create()</code> operations.</p>

<p>This API comes in two flavors. <code class="language-plaintext highlighter-rouge">first_or_create()</code> does not raise an exception
when validation fails, while <code class="language-plaintext highlighter-rouge">first_or_create!()</code> does.</p>

<h2 id="optimized-updates">Optimized Updates</h2>

<p>When using updating a model, NoBrainer uses the <a href="/docs/dirty_tracking">dirty tracking</a>
information to only update the fields that changed. When no attribute changed,
the database update query is skipped, but all callbacks are still executed.</p>

      </article>
    </div>

    <div class="clear"></div>

  </div>
</section>


  <footer>
  <div class="grid">
    <div class="unit whole">
      NoBrainer was created by <a href="https://github.com/nviennot">Nicolas Viennot</a>
      and is maintained by <a href="https://github.com/zedtux">Guillaume Hain</a>.
    </div>
  </div>
</footer>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46753546-1', 'nobrainer.io');
  ga('send', 'pageview');
</script>

</body>
</html>
